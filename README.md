# ansible_spec_plus

Tests Ansible roles, hosts and playbooks separately with Serverspec. Provides test coverage. Supports local and remote test execution.

This is a Ruby gem that uses the [Ansible Config Parser for Serverspec](https://github.com/volanja/ansible_spec) connector and
extends it to be able to run tests for roles, hosts or playbooks separately.

# Features

- Supports all features of [ansible_spec](https://github.com/volanja/ansible_spec)
- Supports listing of available tests
- Supports separate test execution of role tests
- Supports separate test execution of host tests
- Supports separate test execution of playbook tests (playbook tests combine role and hosts tests)
- Supports resource code/test coverage
- Supports remote (default) and local test execution (on a Vagrant box for example) by a command switch

# Installation

```
$ gem install ansible_spec_plus
```

# Usage

## Create necessary files

```
$ asp-init
    create  spec
    create  spec/spec_helper.rb
    create  .ansiblespec
    create  .rspec
```

## [Optional] `site.yml`

This files describes the master playbook and includes all your custom
playbooks. Ansible Spec plus relies on all entries when it comes to
playbooks. If you ever create a playbook, make sure to add it into `site.yml`,
too.

```site.yml
- include: demo.yml
- include: another-playbook.yml
```

## [Optional] `.ansiblespec`

By default, `site.yml` will be used as the playbook and `hosts` as the
inventory file. You can either follow these conventions or you can
customize the playbook and inventory using an `.ansiblespec` file.

```.ansiblespec
---
-
  playbook: site.yml
  inventory: hosts
  hash_behaviour: merge
```

## [Optional] `.rspec`

Test coverage calculation rested on RSpec's JSON report.

```.rspec
--color
--format documentation
--format json --out report.json
```

## Inventory

All inventory files from [ansible_spec](https://github.com/volanja/ansible_spec) are supported
as well as Vagrant-style inventory files like this:

```hosts
# Generated by Vagrant

dev ansible_ssh_host=127.0.0.1 ansible_ssh_port=2222 ansible_ssh_private_key_file=private_key ansible_ssh_user=vagrant
```

These Vagrant-style inventories will be created by Vagrant's VAI plugin. No need to add this to
version control. Install the VAI plugin with `vagrant plugin install vai` and add this section
to your Vagrantfile:

```Vagrantfile
config.vm.provision :vai do |ansible|
  ansible.inventory_dir = './'
  ansible.inventory_filename = 'hosts'
end
```

## Sample

Please see [ansible-example](https://github.com/consort-it/ansible-example) for a full working example.

```
├── Gemfile
├── Gemfile.lock
├── README.md
├── Vagrantfile
├── ansible.cfg
├── demo.yml
├── hosts
├── report.json
├── roles
│   ├── common
│   │   ├── defaults
│   │   │   └── main.yml
│   │   ├── spec
│   │   │   └── main_spec.rb
│   │   ├── tasks
│   │   │   └── main.yml
│   │   └── templates
│   │       └── profile
│   ├── demo
│   │   ├── spec
│   │   │   └── main_spec.rb
│   │   └── tasks
│   │       └── main.yml
│   └── docker
│       ├── defaults
│       │   └── main.yml
│       ├── spec
│       │   └── main_spec.rb
│       ├── tasks
│       │   └── main.yml
│       └── templates
│           ├── config.json
│           └── docker.cfg
├── scripts
│   └── bootstrap_ansible.sh
├── site.yml
└── spec
    ├── demo
    │   └── demo_spec.rb
    └── spec_helper.rb
```

## Running tests

#### Role tests

Role tests can be found under `roles/<name of your role>/spec/*_spec.rb`. Execute tests by simply typing

```
asp rolespec <name of your role>
```

or - for local test execution on a Vagrant box -

```
asp rolespec <name of your role> -l
```

#### Host tests

Host tests can be found under `spec/<name of your host>/*_spec.rb`. Execute tests by simply typing

```
asp hostspec <name of your host>
```

or - for local test execution on a Vagrant box -

```
asp hostspec <name of your host> -l
```

#### Playbook tests

Host tests combine role and host tests for a given playbook. Execute tests by simply typing

```
asp playbookspec <name of your playbook>
```

or - for local test execution on a Vagrant box -

```
asp playbookspec <name of your playbook> -l
```

# Contributing

* Fork it
* Write awesome code
* Test your awesome code (`bundle exec guard` and `rspec` are your friends)
* Create your feature branch (`git checkout -b my-new-feature`)
* Commit your changes (`git commit -am 'Add some feature'`)
* Push to the branch (`git push origin my-new-feature`)
* Create new Pull Request at https://github.com/consort-it/ansible_spec_plus
* Contact us
